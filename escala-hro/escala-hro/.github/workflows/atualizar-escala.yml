name: Atualizar Escala HRO Diariamente

on:
  schedule:
    # 7h01 de Brasília = 10h01 UTC (horário de inverno) = 11h01 UTC (horário de verão)
    - cron: '1 10 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install selenium python-dotenv beautifulsoup4

      - name: Set environment variables
        run: |
          echo "ESCALA_USERNAME=${{ secrets.ESCALA_USERNAME }}" >> $GITHUB_ENV
          echo "ESCALA_PASSWORD=${{ secrets.ESCALA_PASSWORD }}" >> $GITHUB_ENV

      - name: Run extraction (extracao_inteligente.py)
        run: |
          python3 extracao_inteligente.py
          echo "✅ Extração concluída"

      - name: Convert data format (converter_inteligente.py)
        run: |
          python3 converter_inteligente.py
          echo "✅ Conversão de dados concluída"

      - name: Generate dashboard (gerar_dashboard_executivo.py)
        run: |
          python3 gerar_dashboard_executivo.py
          echo "✅ Dashboard gerado"

      - name: Update GitHub Pages with new data
        run: |
          cd escala-hro/escala-hro
          cp /tmp/dashboard_executivo.html index.html
          echo "✅ Arquivo atualizado"

      - name: Commit and push changes
        run: |
          cd escala-hro/escala-hro
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html
          git commit -m "Atualização automática de escalas - $(date '+%d/%m/%Y %H:%M:%S')" || true
          git push origin main || true

      - name: Log completion
        run: |
          echo "✅ Atualização concluída em $(date '+%d/%m/%Y %H:%M:%S')"
