name: Atualizar Dashboard Escala HRO

on:
  # Executa todos os dias às 07h01 (horário de Brasília = 10h01 UTC)
  schedule:
    - cron: '1 10 * * *'  # 10h01 UTC = 07h01 Brasília

  # Permite execução manual para testes
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager

    - name: Instalar Chrome
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable

    - name: Extrair dados do Escala
      run: |
        pwd
        ls -la
        python3 extracao_inteligente.py 2>&1 | tee /tmp/extracao.log
      continue-on-error: true

    - name: Converter dados
      run: |
        python3 converter_inteligente.py 2>&1 | tee /tmp/converter.log
      continue-on-error: true

    # Dashboard gerado manualmente e mantido no repositório
    # Isso garante que as mudanças de layout/styling não sejam sobrescritas
    # pelo gerador automatizado. O index.html é atualizado manualmente
    # e sincronizado com gerar_dashboard_executivo.py quando necessário.

    - name: Commit e Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add index.html
        git commit -m "✅ Dashboard atualizado automaticamente às $(date -u +'%H:%M:%S UTC')" || echo "Nenhuma mudança para commitar"
        git push
      continue-on-error: true

    - name: Upload logs em caso de erro
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-falha
        path: |
          /tmp/*.log
          /tmp/*.txt
        retention-days: 7
